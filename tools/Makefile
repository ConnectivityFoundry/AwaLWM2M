FILES:=awa-client-define_cmdline    \
       awa-client-set_cmdline       \
       awa-client-get_cmdline       \
       awa-client-subscribe_cmdline \
       awa-client-delete_cmdline    \
       awa-client-explore_cmdline   \
       \
       awa-server-define_cmdline                  \
       awa-server-explore_cmdline                 \
       awa-server-read_cmdline                    \
       awa-server-write_cmdline                   \
       awa-server-write-attributes_cmdline        \
       awa-server-delete_cmdline                  \
       awa-server-list-clients_cmdline            \
       awa-server-create_cmdline                  \
       awa-server-execute_cmdline                 \
       awa-server-observe_cmdline

# prevent autodeletion of intermediate files:
#.SECONDARY:

all: $(FILES:=.c)

.PHONY: gen_cmdline
gen_cmdline: $(FILES)

#awa-server-define.cmdline: awa-server-define-base.cmdline define-common.cmdline
#	cat $^ > $@

%-define.cmdline: %-define-base.cmdline define-common.cmdline
	echo "# THIS FILE IS AUTOGENERATED - DO NOT EDIT!" > $@
	cat $^ >> $@

%_cmdline.c %_cmdline.h: %.cmdline
	gengetopt --input=$^ --include-getopt --unamed-opts=PATHS --file $*_cmdline

.PHONY: clean
clean:
	rm -f $(FILES:=.c) $(FILES:=.h)
	rm -f awa-client-define.cmdline awa-server-define.cmdline

# BUILD_DIR may be overridden by caller Makefile,
# otherwise use a sensible default for local development
BUILD_DIR_ABS=$(realpath ../$(BUILD_DIR))
export LWM2M_TOOLS_PATH:=$(BUILD_DIR_ABS)/tools
export LWM2M_CLIENTD_BIN:=$(BUILD_DIR_ABS)/core/src/client/awa_clientd
export LWM2M_SERVERD_BIN:=$(BUILD_DIR_ABS)/core/src/server/awa_serverd
export LWM2M_BOOTSTRAPD_BIN:=$(BUILD_DIR_ABS)/core/src/bootstrap/awa_bootstrapd

# Tool tests use environment variables to locate binaries:
#   LWM2M_TOOLS_PATH     : absolute path of LWM2M tool binaries
#   LWM2M_CLIENTD_BIN    : absolute path of awa_clientd binary
#   LWM2M_SERVERD_BIN    : absolute path of awa_serverd binary
#   LWM2M_BOOTSTRAPD_BIN : absolute path of awa_bootstrapd binary
#

# Test files within the tests/python directory:
TEST_FILES:= \
  test_awa_client_set.py \
  test_awa_client_get.py \
  test_awa_client_define.py \
  test_awa_server_define.py \
  test_awa_client_subscribe.py \
  test_awa_client_explore.py \
  test_awa_client_delete.py \
  test_awa_client.py \
  test_awa_server_list_clients.py \
  test_awa_server_list_clients_multiple.py \
  test_awa_server_observe.py \
  test_awa_server_read.py \
  test_awa_server_write.py \
  test_awa_server_delete.py \
  test_awa_server_execute.py \
  test_awa_server_write_attributes.py \
  test_awa_server.py \
  test_awa_client_server_interaction.py
# test_awa_server_discover.py

.PHONY: tests
tests:
	cd tests && ./run_tests $(TEST_FILES) --with-xunit --xunit-file=tools_tests.xml
